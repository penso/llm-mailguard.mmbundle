#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Configure LLM Spam Classifier settings.
Stores API key in macOS Keychain and other settings in a JSON config file.
"""

import sys
from llm_common import (
    DEFAULT_PROVIDER, DEFAULT_ENDPOINT, DEFAULT_MODEL,
    show_dialog, show_alert, load_config, save_config,
    get_api_key_from_keychain, save_api_key_to_keychain
)


def main():
    # Load existing config
    config = load_config() or {}
    existing_key = get_api_key_from_keychain()
    
    # Provider Name
    default_name = config.get("provider_name", DEFAULT_PROVIDER)
    provider_name = show_dialog(
        "Enter the LLM provider name:",
        default_answer=default_name
    )
    if provider_name is None:
        sys.exit(0)  # User cancelled
    
    # Endpoint URL
    default_endpoint = config.get("endpoint", DEFAULT_ENDPOINT)
    endpoint = show_dialog(
        "Enter the API endpoint URL:",
        default_answer=default_endpoint
    )
    if endpoint is None:
        sys.exit(0)
    
    # Model
    default_model = config.get("model", DEFAULT_MODEL)
    model = show_dialog(
        "Enter the model name:",
        default_answer=default_model
    )
    if model is None:
        sys.exit(0)
    
    # API Key
    key_hint = "(current key saved)" if existing_key else "(leave empty for local endpoints)"
    api_key = show_dialog(
        f"Enter the API key {key_hint}:\n(Leave empty to keep existing key)",
        hidden=True
    )
    if api_key is None:
        sys.exit(0)
    
    # Save configuration
    config["provider_name"] = provider_name
    config["endpoint"] = endpoint
    config["model"] = model
    save_config(config)
    
    # Privacy warning
    privacy_warning = (
        "\n\nWARNING: Checking emails for spam will send the complete raw message "
        "(including sender, recipients, and full content) to the configured LLM provider. "
        "Be mindful of privacy when using cloud-based LLMs. "
        "For sensitive emails, consider using a local LLM (Ollama, LM Studio)."
    )
    
    # Save API key to Keychain if provided
    if api_key:
        if save_api_key_to_keychain(api_key):
            show_alert(f"Configuration saved successfully!\n\nProvider: {provider_name}\nEndpoint: {endpoint}\nModel: {model}\nAPI Key: (saved to Keychain){privacy_warning}")
        else:
            show_alert("Configuration saved, but failed to save API key to Keychain. Please try again.")
    else:
        if existing_key:
            show_alert(f"Configuration saved successfully!\n\nProvider: {provider_name}\nEndpoint: {endpoint}\nModel: {model}\nAPI Key: (unchanged){privacy_warning}")
        else:
            show_alert(f"Configuration saved!\n\nProvider: {provider_name}\nEndpoint: {endpoint}\nModel: {model}\nAPI Key: (not set - required for most providers){privacy_warning}")


if __name__ == "__main__":
    main()
